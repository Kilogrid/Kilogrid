<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Kilogrid: src/dispatcher/tracking.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Kilogrid
   </div>
   <div id="projectbrief">Kilogrid library documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tracking_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">tracking.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &quot;string.h&quot;</code><br />
<code>#include &lt;avr/interrupt.h&gt;</code><br />
<code>#include &quot;Dispatcher.h&quot;</code><br />
<code>#include &quot;<a class="el" href="serial__packet_8h_source.html">serial_packet.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="tracking_8h_source.html">tracking.h</a>&quot;</code><br />
<code>#include &quot;debug.h&quot;</code><br />
</div>
<p><a href="tracking_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a8d3a53f13f4689de94c017358eed6e31"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a8d3a53f13f4689de94c017358eed6e31">test_serial_tracking</a> ()</td></tr>
<tr class="memdesc:a8d3a53f13f4689de94c017358eed6e31"><td class="mdescLeft">&#160;</td><td class="mdescRight">Test filling in buffer and try sending dummy data (verify in KiloGUI).  <a href="#a8d3a53f13f4689de94c017358eed6e31">More...</a><br /></td></tr>
<tr class="separator:a8d3a53f13f4689de94c017358eed6e31"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a325d7bbe289c033e3e67c5a510a9cb32"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a325d7bbe289c033e3e67c5a510a9cb32">tracking_try_send</a> (uint8_t force_dump)</td></tr>
<tr class="memdesc:a325d7bbe289c033e3e67c5a510a9cb32"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function that handles the sending of tracking messages to the pc. Serial packets are slow, therefore we only send at certain intervals (PACKET_SEND_TIMEOUT) or when the buffer has TRACKING_ITEM_SEND_TRIGGER messages stored. The reason for the latter is that we cannot predict the rate of the incoming tracking messages precisely and want to minimize the chance of dropping messages because the buffer is full. force_dump: force dump serial packet data if equal to 1.  <a href="#a325d7bbe289c033e3e67c5a510a9cb32">More...</a><br /></td></tr>
<tr class="separator:a325d7bbe289c033e3e67c5a510a9cb32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d6497aca5c088df2bfc26762c98d8a5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a1d6497aca5c088df2bfc26762c98d8a5">tracking_init</a> (uint8_t tracking_item_trigger)</td></tr>
<tr class="separator:a1d6497aca5c088df2bfc26762c98d8a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a03ee629435ead826ee695093a747fce7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a03ee629435ead826ee695093a747fce7">tracking_message_received</a> (<a class="el" href="kilogrid_8h.html#a87a8f7271d93f02214d31e4c7b90d06a">kilogrid_address_t</a> address, uint8_t cell, <a class="el" href="kilogrid_8h.html#a076098c0af2ea2c910e2e870dfb07091">tracking_user_data_t</a> *data)</td></tr>
<tr class="memdesc:a03ee629435ead826ee695093a747fce7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called from CAN received interrupt, copies the message to the buffer and sets the address and timestamp fields.  <a href="#a03ee629435ead826ee695093a747fce7">More...</a><br /></td></tr>
<tr class="separator:a03ee629435ead826ee695093a747fce7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a90ff2d1b8c62fee25dc122442df2187c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a90ff2d1b8c62fee25dc122442df2187c">init_serial_packet_tracking</a> (<a class="el" href="tracking_8h.html#a04dd7d24dc08aa42aac67838fc9a73fe">serial_packet_tracking_t</a> *s)</td></tr>
<tr class="separator:a90ff2d1b8c62fee25dc122442df2187c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5173d86e7978ac3fb585591a65c772df"><td class="memItemLeft" align="right" valign="top">volatile uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a5173d86e7978ac3fb585591a65c772df">current_tracking_index</a> = 0</td></tr>
<tr class="separator:a5173d86e7978ac3fb585591a65c772df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a88d07cf820462e885f3b91a0c1c1f65f"><td class="memItemLeft" align="right" valign="top">volatile uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a88d07cf820462e885f3b91a0c1c1f65f">tracking_item_send_trigger</a> = 0</td></tr>
<tr class="separator:a88d07cf820462e885f3b91a0c1c1f65f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0c23bca2058d65e0f97cf80cd70d00f1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="tracking_8h.html#a04dd7d24dc08aa42aac67838fc9a73fe">serial_packet_tracking_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="tracking_8c.html#a0c23bca2058d65e0f97cf80cd70d00f1">serial_packet_tracking</a></td></tr>
<tr class="memdesc:a0c23bca2058d65e0f97cf80cd70d00f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Serial packet structure that will contain tracking data from the buffer.  <a href="#a0c23bca2058d65e0f97cf80cd70d00f1">More...</a><br /></td></tr>
<tr class="separator:a0c23bca2058d65e0f97cf80cd70d00f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a90ff2d1b8c62fee25dc122442df2187c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_serial_packet_tracking </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="tracking_8h.html#a04dd7d24dc08aa42aac67838fc9a73fe">serial_packet_tracking_t</a> *&#160;</td>
          <td class="paramname"><em>s</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00138">138</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8d3a53f13f4689de94c017358eed6e31"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void test_serial_tracking </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Test filling in buffer and try sending dummy data (verify in KiloGUI). </p>

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00111">111</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1d6497aca5c088df2bfc26762c98d8a5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tracking_init </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>tracking_item_trigger</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00060">60</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a03ee629435ead826ee695093a747fce7"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void tracking_message_received </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kilogrid_8h.html#a87a8f7271d93f02214d31e4c7b90d06a">kilogrid_address_t</a>&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>cell</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="kilogrid_8h.html#a076098c0af2ea2c910e2e870dfb07091">tracking_user_data_t</a> *&#160;</td>
          <td class="paramname"><em>data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Called from CAN received interrupt, copies the message to the buffer and sets the address and timestamp fields. </p>
<p>  </p>

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00071">71</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a325d7bbe289c033e3e67c5a510a9cb32"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t tracking_try_send </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>force_dump</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Function that handles the sending of tracking messages to the pc. Serial packets are slow, therefore we only send at certain intervals (PACKET_SEND_TIMEOUT) or when the buffer has TRACKING_ITEM_SEND_TRIGGER messages stored. The reason for the latter is that we cannot predict the rate of the incoming tracking messages precisely and want to minimize the chance of dropping messages because the buffer is full. force_dump: force dump serial packet data if equal to 1. </p>
<p>First it saves the current state: timestamp and message_counter. Then sends the data back to the pc. To finish up it moves all messages received in the meantime to the beginning of the tracking_items_buffer.</p>
<p>Sent message structure is as follows:</p>
<p>SERIAL_PACKET_HEADER 1 byte type: SERIAL_PACKET_TRACKING 1 byte total length of the data in bytes 1 byte base timestamp 4 bytes tracking messages n * sizeof(tracking_item_t) checksum 1 byte </p>

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00044">44</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a5173d86e7978ac3fb585591a65c772df"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint8_t current_tracking_index = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00010">10</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a0c23bca2058d65e0f97cf80cd70d00f1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="tracking_8h.html#a04dd7d24dc08aa42aac67838fc9a73fe">serial_packet_tracking_t</a> serial_packet_tracking</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Serial packet structure that will contain tracking data from the buffer. </p>

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00015">15</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
<a class="anchor" id="a88d07cf820462e885f3b91a0c1c1f65f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint8_t tracking_item_send_trigger = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="tracking_8c_source.html#l00012">12</a> of file <a class="el" href="tracking_8c_source.html">tracking.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
